@namespace BlazorBlueprint.Components
@using BlazorBlueprint.Icons.Lucide.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@ContainerClass">
    @* Dropzone *@
    <div @ref="_dropzoneRef"
         class="@DropzoneClass"
         @ondragenter="HandleDragEnter"
         @ondragleave="HandleDragLeave"
         @ondragover="HandleDragOver"
         @ondragover:preventDefault="true">

        <InputFile @ref="_inputFile"
                   OnChange="HandleFileSelected"
                   accept="@Accept"
                   multiple="@Multiple"
                   disabled="@Disabled"
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                   id="@_inputId" />

        @if (DropzoneContent != null)
        {
            @DropzoneContent
        }
        else
        {
            <div class="flex flex-col items-center gap-2 pointer-events-none">
                <div class="p-3 rounded-full bg-muted">
                    <LucideIcon Name="upload" Class="h-6 w-6 text-muted-foreground" />
                </div>
                <div class="text-center">
                    <p class="text-sm font-medium">
                        @if (_isDragging)
                        {
                            <span>Drop files here</span>
                        }
                        else
                        {
                            <span>Drag and drop files here</span>
                        }
                    </p>
                    <p class="text-xs text-muted-foreground mt-1">
                        or <span class="text-primary underline">browse</span> to upload
                    </p>
                </div>
                @if (!string.IsNullOrEmpty(Accept))
                {
                    <p class="text-xs text-muted-foreground">
                        Accepted: @Accept
                    </p>
                }
                <p class="text-xs text-muted-foreground">
                    Max size: @FormatSize(MaxFileSize)
                    @if (Multiple)
                    {
                        <span> | Max files: @MaxFileCount</span>
                    }
                </p>
            </div>
        }
    </div>

    @* File List *@
    @if (_files.Count > 0)
    {
        <div class="mt-4 space-y-2">
            @foreach (var file in _files)
            {
                <div class="@FileItemClass">
                    @* Preview or Icon *@
                    <div class="flex-shrink-0">
                        @if (ShowPreview && file.IsImage && !string.IsNullOrEmpty(file.PreviewUrl))
                        {
                            <img src="@file.PreviewUrl"
                                 alt="@file.Name"
                                 class="h-12 w-12 rounded object-cover" />
                        }
                        else
                        {
                            <div class="h-12 w-12 rounded bg-muted flex items-center justify-center">
                                <LucideIcon Name="@GetFileIcon(file)" Class="h-6 w-6 text-muted-foreground" />
                            </div>
                        }
                    </div>

                    @* File Info *@
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">@file.Name</p>
                        <p class="text-xs text-muted-foreground">@file.FormattedSize</p>
                    </div>

                    @* Remove Button *@
                    <BbButton Variant="ButtonVariant.Ghost"
                            Size="ButtonSize.Icon"
                            Class="h-8 w-8 flex-shrink-0"
                            OnClick="@(() => RemoveFile(file))"
                            Disabled="@Disabled"
                            AriaLabel="@($"Remove {file.Name}")">
                        <LucideIcon Name="x" Class="h-4 w-4" />
                    </BbButton>
                </div>
            }
        </div>
    }

    @* Validation Errors *@
    @if (_errors.Count > 0)
    {
        <div class="mt-2 space-y-1">
            @foreach (var error in _errors)
            {
                <p class="text-sm text-destructive flex items-center gap-1">
                    <LucideIcon Name="alert-circle" Class="h-4 w-4" />
                    @error.Message
                </p>
            }
        </div>
    }
</div>

@code {
    private InputFile? _inputFile;
    private ElementReference _dropzoneRef;
    private string _inputId = $"file-upload-{Guid.NewGuid():N}";
    private bool _isDragging;
    private bool _jsInitialized;
    private List<FileUploadItem> _files = new();
    private List<FileValidationError> _errors = new();
    private IJSObjectReference? _jsModule;
    private IJSObjectReference? _jsCleanup;

    /// <summary>
    /// Gets or sets the selected files.
    /// </summary>
    [Parameter]
    public IReadOnlyList<FileUploadItem>? Files { get; set; }

    /// <summary>
    /// Callback when files change.
    /// </summary>
    [Parameter]
    public EventCallback<IReadOnlyList<FileUploadItem>> FilesChanged { get; set; }

    /// <summary>
    /// Whether multiple files can be selected.
    /// </summary>
    [Parameter]
    public bool Multiple { get; set; }

    /// <summary>
    /// Accepted file types (MIME types or extensions).
    /// </summary>
    [Parameter]
    public string? Accept { get; set; }

    /// <summary>
    /// Maximum file size in bytes.
    /// </summary>
    [Parameter]
    public long MaxFileSize { get; set; } = 10 * 1024 * 1024; // 10MB

    /// <summary>
    /// Maximum number of files.
    /// </summary>
    [Parameter]
    public int MaxFileCount { get; set; } = 10;

    /// <summary>
    /// Whether to show image previews.
    /// </summary>
    [Parameter]
    public bool ShowPreview { get; set; } = true;

    /// <summary>
    /// Whether the upload is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Callback when validation errors occur.
    /// </summary>
    [Parameter]
    public EventCallback<FileValidationError> OnValidationError { get; set; }

    /// <summary>
    /// Custom dropzone content.
    /// </summary>
    [Parameter]
    public RenderFragment? DropzoneContent { get; set; }

    /// <summary>
    /// Additional CSS classes.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    protected override void OnParametersSet()
    {
        if (Files != null && !ReferenceEquals(Files, _files))
        {
            _files = Files.ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_jsInitialized && _inputFile != null)
        {
            try
            {
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/BlazorBlueprint.Components/js/file-upload.js");

                // Get the underlying input element from InputFile
                _jsCleanup = await _jsModule.InvokeAsync<IJSObjectReference>(
                    "initializeDropZone", _dropzoneRef, _inputFile.Element);

                _jsInitialized = true;
            }
            catch (JSDisconnectedException)
            {
                // Expected during circuit disconnect
            }
            catch (InvalidOperationException)
            {
                // JS interop not available during prerendering
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_jsCleanup != null)
        {
            try
            {
                await _jsCleanup.InvokeVoidAsync("dispose");
                await _jsCleanup.DisposeAsync();
            }
            catch (JSDisconnectedException) { }
        }

        if (_jsModule != null)
        {
            try
            {
                await _jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException) { }
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _errors.Clear();
        var filesToAdd = new List<FileUploadItem>();

        foreach (var file in e.GetMultipleFiles(MaxFileCount + _files.Count))
        {
            var validationError = ValidateFile(file);
            if (validationError != null)
            {
                _errors.Add(validationError);
                await OnValidationError.InvokeAsync(validationError);
                continue;
            }

            if (_files.Count + filesToAdd.Count >= MaxFileCount)
            {
                var error = new FileValidationError
                {
                    FileName = file.Name,
                    ErrorType = FileValidationErrorType.TooManyFiles,
                    Message = $"Maximum {MaxFileCount} files allowed"
                };
                _errors.Add(error);
                await OnValidationError.InvokeAsync(error);
                break;
            }

            var item = new FileUploadItem { File = file };

            // Generate preview for images
            if (ShowPreview && item.IsImage && file.Size < 5 * 1024 * 1024) // Only preview images < 5MB
            {
                try
                {
                    var format = file.ContentType;
                    var resizedImage = await file.RequestImageFileAsync(format, 200, 200);
                    using var stream = resizedImage.OpenReadStream(5 * 1024 * 1024);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    var base64 = Convert.ToBase64String(ms.ToArray());
                    item.PreviewUrl = $"data:{format};base64,{base64}";
                }
                catch
                {
                    // Preview generation failed, continue without preview
                }
            }

            filesToAdd.Add(item);
        }

        if (filesToAdd.Count > 0)
        {
            if (!Multiple)
            {
                _files.Clear();
            }
            _files.AddRange(filesToAdd);
            await FilesChanged.InvokeAsync(_files);
        }
    }

    private FileValidationError? ValidateFile(IBrowserFile file)
    {
        // Check file size
        if (file.Size > MaxFileSize)
        {
            return new FileValidationError
            {
                FileName = file.Name,
                ErrorType = FileValidationErrorType.FileTooLarge,
                Message = $"{file.Name} exceeds {FormatSize(MaxFileSize)} limit"
            };
        }

        // Check file type
        if (!string.IsNullOrEmpty(Accept))
        {
            var accepted = Accept.Split(',').Select(a => a.Trim().ToLowerInvariant()).ToList();
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            var contentType = file.ContentType.ToLowerInvariant();

            var isAccepted = accepted.Any(a =>
                a == extension ||
                a == contentType ||
                (a.EndsWith("/*") && contentType.StartsWith(a.Replace("/*", "/")))
            );

            if (!isAccepted)
            {
                return new FileValidationError
                {
                    FileName = file.Name,
                    ErrorType = FileValidationErrorType.InvalidType,
                    Message = $"{file.Name} is not an accepted file type"
                };
            }
        }

        return null;
    }

    private async Task RemoveFile(FileUploadItem file)
    {
        _files.Remove(file);
        await FilesChanged.InvokeAsync(_files);
    }

    private void TriggerFileInput()
    {
        if (Disabled) return;
        // Trigger click on the hidden input via JS or label
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (Disabled) return;
        if (e.Key == "Enter" || e.Key == " ")
        {
            TriggerFileInput();
        }
    }

    private void HandleDragEnter(DragEventArgs e)
    {
        if (Disabled) return;
        _isDragging = true;
    }

    private void HandleDragLeave(DragEventArgs e)
    {
        _isDragging = false;
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Prevent default to allow drop
    }

    private void HandleDrop(DragEventArgs e)
    {
        _isDragging = false;
        // The InputFile component handles the actual file drop
    }

    private string GetFileIcon(FileUploadItem file)
    {
        var contentType = file.ContentType.ToLowerInvariant();

        if (contentType.StartsWith("image/")) return "image";
        if (contentType.StartsWith("video/")) return "video";
        if (contentType.StartsWith("audio/")) return "music";
        if (contentType.Contains("pdf")) return "file-text";
        if (contentType.Contains("word") || contentType.Contains("document")) return "file-text";
        if (contentType.Contains("excel") || contentType.Contains("spreadsheet")) return "table";
        if (contentType.Contains("zip") || contentType.Contains("compressed")) return "file-archive";
        if (contentType.Contains("text") || contentType.Contains("json") || contentType.Contains("xml")) return "file-code";

        return "file";
    }

    private static string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F0} KB";
        if (bytes < 1024 * 1024 * 1024) return $"{bytes / (1024.0 * 1024):F0} MB";
        return $"{bytes / (1024.0 * 1024 * 1024):F1} GB";
    }

    private string ContainerClass => ClassNames.cn(
        "w-full",
        Class
    );

    private string DropzoneClass => ClassNames.cn(
        "relative flex flex-col items-center justify-center",
        "w-full min-h-[150px] p-6",
        "border-2 border-dashed rounded-lg",
        "transition-colors cursor-pointer",
        _isDragging ? "border-primary bg-primary/5" : "border-muted-foreground/25 hover:border-muted-foreground/50",
        Disabled ? "opacity-50 cursor-not-allowed" : null
    );

    private string FileItemClass => ClassNames.cn(
        "flex items-center gap-3 p-3",
        "border rounded-lg bg-muted/30"
    );
}
