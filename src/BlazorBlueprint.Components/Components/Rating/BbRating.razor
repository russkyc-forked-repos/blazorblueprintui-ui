@namespace BlazorBlueprint.Components

<div role="radiogroup"
     aria-label="@(AriaLabel ?? "Rating")"
     class="@CssClass"
     @onmouseleave="HandleMouseLeave"
     @onkeydown="HandleKeyDown"
     tabindex="@(Disabled || ReadOnly ? -1 : 0)">
    @for (int i = 1; i <= Max; i++)
    {
        var index = i;
        var fill = GetFillPercentage(index);
        var isHovered = _hoverValue > 0 && index <= Math.Ceiling(_hoverValue);

        <span role="radio"
              aria-checked="@(index <= Value)"
              aria-label="@($"{index} out of {Max}")"
              class="@GetIconContainerClass(index)"
              @onclick="() => HandleClick(index)"
              @onmousemove="e => HandleMouseMove(e, index)">
            @if (IconTemplate != null)
            {
                @IconTemplate(new RatingIconContext
                {
                    Index = index,
                    Fill = fill,
                    IsHovered = isHovered,
                    ActiveColor = ActiveColor,
                    InactiveColor = InactiveColor
                })
            }
            else
            {
                @RenderIcon(fill)
            }
        </span>
    }
</div>

@code {
    private RenderFragment RenderIcon(double fill)
    {
        return Icon switch
        {
            RatingIcon.Star => RenderStar(fill),
            RatingIcon.Heart => RenderHeart(fill),
            RatingIcon.Circle => RenderCircle(fill),
            _ => RenderStar(fill)
        };
    }

    private RenderFragment RenderStar(double fill) => __builder =>
    {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="@IconClass">
            <defs>
                <linearGradient id="@($"star-gradient-{_instanceId}-{fill}")">
                    <stop offset="@($"{fill * 100}%")" stop-color="@(ActiveColor ?? "currentColor")" class="@(fill > 0 ? "text-yellow-400" : "")" />
                    <stop offset="@($"{fill * 100}%")" stop-color="@(InactiveColor ?? "currentColor")" class="text-muted-foreground/30" />
                </linearGradient>
            </defs>
            <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                fill="@($"url(#star-gradient-{_instanceId}-{fill})")"
                stroke="@(fill > 0 ? (ActiveColor ?? "currentColor") : (InactiveColor ?? "currentColor"))"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="@(fill > 0 ? "text-yellow-400" : "text-muted-foreground/30")" />
        </svg>
    };

    private RenderFragment RenderHeart(double fill) => __builder =>
    {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="@IconClass">
            <defs>
                <linearGradient id="@($"heart-gradient-{_instanceId}-{fill}")">
                    <stop offset="@($"{fill * 100}%")" stop-color="@(ActiveColor ?? "currentColor")" class="@(fill > 0 ? "text-red-500" : "")" />
                    <stop offset="@($"{fill * 100}%")" stop-color="@(InactiveColor ?? "currentColor")" class="text-muted-foreground/30" />
                </linearGradient>
            </defs>
            <path
                d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
                fill="@($"url(#heart-gradient-{_instanceId}-{fill})")"
                stroke="@(fill > 0 ? (ActiveColor ?? "currentColor") : (InactiveColor ?? "currentColor"))"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="@(fill > 0 ? "text-red-500" : "text-muted-foreground/30")" />
        </svg>
    };

    private RenderFragment RenderCircle(double fill) => __builder =>
    {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="@IconClass">
            <defs>
                <linearGradient id="@($"circle-gradient-{_instanceId}-{fill}")">
                    <stop offset="@($"{fill * 100}%")" stop-color="@(ActiveColor ?? "currentColor")" class="@(fill > 0 ? "text-primary" : "")" />
                    <stop offset="@($"{fill * 100}%")" stop-color="@(InactiveColor ?? "currentColor")" class="text-muted-foreground/30" />
                </linearGradient>
            </defs>
            <circle
                cx="12"
                cy="12"
                r="10"
                fill="@($"url(#circle-gradient-{_instanceId}-{fill})")"
                stroke="@(fill > 0 ? (ActiveColor ?? "currentColor") : (InactiveColor ?? "currentColor"))"
                stroke-width="1.5"
                class="@(fill > 0 ? "text-primary" : "text-muted-foreground/30")" />
        </svg>
    };
}
