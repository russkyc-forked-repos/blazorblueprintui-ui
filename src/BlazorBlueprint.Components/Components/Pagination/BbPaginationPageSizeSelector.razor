@namespace BlazorBlueprint.Components

<div class="@CssClass">
    @if (ShowLabel)
    {
        <p class="text-sm font-medium">@Label</p>
    }
    <BbSelect TValue="string"
            Value="@_pageSizeValue"
            ValueChanged="@HandlePageSizeChanged">
        <BbSelectTrigger Class="@TriggerCssClass">
            <BbSelectValue />
        </BbSelectTrigger>
        <BbSelectContent>
            @foreach (var size in EffectivePageSizes)
            {
                <BbSelectItem Value="@size.ToString()">@size</BbSelectItem>
            }
        </BbSelectContent>
    </BbSelect>
</div>

@code {
    private string _pageSizeValue = "10";
    private bool _initialized = false;

    [CascadingParameter]
    private PaginationContext? Context { get; set; }

    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// CSS class for the Select trigger element.
    /// </summary>
    [Parameter]
    public string? TriggerClass { get; set; }

    /// <summary>
    /// Whether to show the label. Default: true
    /// </summary>
    [Parameter]
    public bool ShowLabel { get; set; } = true;

    /// <summary>
    /// Label text for the page size selector. Default: "Rows per page"
    /// </summary>
    [Parameter]
    public string Label { get; set; } = "Rows per page";

    /// <summary>
    /// Override page sizes from context. When null, uses context's PageSizes.
    /// </summary>
    [Parameter]
    public int[]? PageSizes { get; set; }

    /// <summary>
    /// Custom callback when page size changes.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnPageSizeChanged { get; set; }

    private int[] EffectivePageSizes => PageSizes ?? Context?.PageSizes ?? [10, 20, 50, 100];

    protected override void OnInitialized()
    {
        if (Context?.State != null)
            _pageSizeValue = Context.State.PageSize.ToString();
        _initialized = true;
    }

    protected override void OnParametersSet()
    {
        if (_initialized && Context?.State != null)
        {
            var currentPageSize = Context.State.PageSize.ToString();
            if (_pageSizeValue != currentPageSize)
                _pageSizeValue = currentPageSize;
        }
    }

    private async Task HandlePageSizeChanged(string newValue)
    {
        _pageSizeValue = newValue;

        if (int.TryParse(newValue, out var newSize))
        {
            if (Context?.State != null && newSize != Context.State.PageSize)
            {
                Context.State.PageSize = newSize;
                Context.State.CurrentPage = 1;

                if (Context.OnPageSizeChanged != null)
                    await Context.OnPageSizeChanged(newSize);
            }

            if (OnPageSizeChanged.HasDelegate)
                await OnPageSizeChanged.InvokeAsync(newSize);
        }
    }

    private string CssClass => ClassNames.cn(
        "flex items-center gap-2",
        Class
    );

    private string TriggerCssClass => ClassNames.cn(
        "h-8 w-[70px]",
        TriggerClass
    );
}
