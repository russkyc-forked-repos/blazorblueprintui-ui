@namespace BlazorBlueprint.Components
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<div @ref="_groupRef" class="@CssClass" style="@Style">
    <CascadingValue Value="this" IsFixed="false">
        @ChildContent
    </CascadingValue>
</div>

@code {
    /// <summary>
    /// The panels to display.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The direction of the panels.
    /// </summary>
    [Parameter]
    public ResizableDirection Direction { get; set; } = ResizableDirection.Horizontal;

    /// <summary>
    /// Additional CSS classes to apply.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    private ElementReference _groupRef;
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<BbResizablePanelGroup>? _dotNetRef;
    private string _groupId = Guid.NewGuid().ToString("N");
    private bool _jsInitialized;
    private bool _disposed;

    private List<double> _panelSizes = new();
    private List<double> _panelDefaultSizes = new();
    private List<double> _panelMinSizes = new();
    private List<double> _panelMaxSizes = new();
    private int _panelCount = 0;
    private int _handleCount = 0;

    internal ResizableDirection GetDirection() => Direction;

    internal int RegisterPanel(double defaultSize, double minSize, double maxSize)
    {
        var index = _panelCount++;
        _panelDefaultSizes.Add(defaultSize);
        _panelMinSizes.Add(minSize);
        _panelMaxSizes.Add(maxSize);

        if (_panelSizes.Count <= index)
        {
            _panelSizes.Add(defaultSize);
        }

        return index;
    }

    internal double GetPanelSize(int index)
    {
        if (index >= 0 && index < _panelSizes.Count)
        {
            return _panelSizes[index];
        }
        return index < _panelDefaultSizes.Count ? _panelDefaultSizes[index] : 50;
    }

    internal int RegisterHandle()
    {
        return _handleCount++;
    }

    internal async Task StartResize(int handleIndex, double clientX, double clientY, long pointerId)
    {
        if (_jsModule != null && _jsInitialized)
        {
            await _jsModule.InvokeVoidAsync("startResize", _groupId, handleIndex, clientX, clientY, _panelSizes.ToArray(), pointerId, _panelMinSizes.ToArray(), _panelMaxSizes.ToArray());
        }
    }

    [JSInvokable]
    public void UpdatePanelSizes(double[] newSizes)
    {
        if (_disposed) return;

        // Input validation
        if (newSizes == null || newSizes.Length == 0)
            return;

        // Reject excessively large arrays (potential DoS)
        if (newSizes.Length > 100)
            return;

        for (int i = 0; i < newSizes.Length && i < _panelSizes.Count; i++)
        {
            // Skip invalid values
            if (double.IsNaN(newSizes[i]) || double.IsInfinity(newSizes[i]))
                continue;

            // Apply min/max constraints
            var size = Math.Max(_panelMinSizes[i], Math.Min(_panelMaxSizes[i], newSizes[i]));
            _panelSizes[i] = size;
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeJsAsync();
        }
    }

    private async Task InitializeJsAsync()
    {
        if (_jsInitialized) return;

        try
        {
            _jsModule = await JS.InvokeAsync<IJSObjectReference>("import",
                "./_content/BlazorBlueprint.Components/js/resizable.js");
            _dotNetRef = DotNetObjectReference.Create(this);

            var isHorizontal = Direction == ResizableDirection.Horizontal;
            await _jsModule.InvokeVoidAsync("initializeResizable", _groupRef, _dotNetRef, _groupId, isHorizontal);
            _jsInitialized = true;
        }
        catch (JSDisconnectedException)
        {
            // Expected during circuit disconnect in Blazor Server
        }
        catch (InvalidOperationException)
        {
            // JS interop not available during prerendering
        }
    }

    private string Style => Direction == ResizableDirection.Horizontal
        ? "display: flex; flex-direction: row; height: 100%; width: 100%;"
        : "display: flex; flex-direction: column; height: 100%; width: 100%;";

    private string CssClass => ClassNames.cn(
        "overflow-hidden",
        Class
    );

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        if (_jsModule != null && _jsInitialized)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("disposeResizable", _groupId);
            }
            catch
            {
                // Cleanup may already be disposed
            }

            try
            {
                await _jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Expected during circuit disconnect
            }
        }
        _dotNetRef?.Dispose();
    }
}
