@namespace BlazorBlueprint.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions

<BbPopover @bind-Open="_isOpen">
    <BbPopoverTrigger AsChild="true">
        <BbButton Variant="ButtonVariant.Outline"
                Class="@ButtonClass"
                Disabled="@Disabled">
            <div class="h-5 w-5 rounded border border-input mr-2"
                 style="background-color: @Value;">
            </div>
            <span class="font-mono text-sm">@DisplayValue</span>
        </BbButton>
    </BbPopoverTrigger>
    <BbPopoverContent Class="w-[280px] p-4" Align="@PopoverAlign.Start">
        <div class="space-y-4">
            @* Color Area (Saturation/Brightness) *@
            <div class="relative h-[150px] w-full rounded-md cursor-crosshair overflow-hidden touch-none"
                 style="background: linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, hsl(@_hue, 100%, 50%));"
                 @onpointerdown="HandleAreaPointerDown"
                 @onpointermove="HandleAreaPointerMove"
                 @onpointerup="HandleAreaPointerUp"
                 @onpointerleave="HandleAreaPointerLeave"
                 @onpointercancel="HandleAreaPointerCancel">
                <div class="absolute h-4 w-4 border-2 border-white rounded-full shadow-md -translate-x-1/2 -translate-y-1/2 pointer-events-none"
                     style="left: @(_saturation * 100)%; top: @((1 - _brightness) * 100)%;">
                </div>
            </div>

            @* Hue Slider *@
            <div class="space-y-2">
                <div class="relative h-3 w-full rounded-md cursor-pointer touch-none"
                     style="background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%);"
                     @onpointerdown="HandleHuePointerDown"
                     @onpointermove="HandleHuePointerMove"
                     @onpointerup="HandleHuePointerUp"
                     @onpointerleave="HandleHuePointerLeave"
                     @onpointercancel="HandleHuePointerCancel">
                    <div class="absolute top-1/2 h-5 w-2 bg-white border border-input rounded shadow-sm -translate-x-1/2 -translate-y-1/2 pointer-events-none"
                         style="left: @(_hue / 360 * 100)%;">
                    </div>
                </div>
            </div>

            @* Alpha Slider *@
            @if (ShowAlpha)
            {
                <div class="space-y-2">
                    <div class="relative h-3 w-full rounded-md cursor-pointer touch-none"
                         style="background: linear-gradient(to right, transparent, @CurrentColorWithoutAlpha), url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 fill-opacity=%22.1%22><rect x=%220%22 y=%220%22 width=%228%22 height=%228%22 fill=%22%23000%22/><rect x=%228%22 y=%228%22 width=%228%22 height=%228%22 fill=%22%23000%22/></svg>');"
                         @onpointerdown="HandleAlphaPointerDown"
                         @onpointermove="HandleAlphaPointerMove"
                         @onpointerup="HandleAlphaPointerUp"
                         @onpointerleave="HandleAlphaPointerLeave"
                         @onpointercancel="HandleAlphaPointerCancel">
                        <div class="absolute top-1/2 h-5 w-2 bg-white border border-input rounded shadow-sm -translate-x-1/2 -translate-y-1/2 pointer-events-none"
                             style="left: @(_alpha * 100)%;">
                        </div>
                    </div>
                </div>
            }

            @* Color Preview & Inputs *@
            @if (ShowInputs)
            {
                <div class="flex gap-2">
                    <div class="h-10 w-10 rounded-md border border-input flex-shrink-0"
                         style="background-color: @Value;">
                    </div>
                    <div class="flex-1">
                        <BbInput Value="@_hexInput"
                               ValueChanged="HandleHexInput"
                               Class="font-mono text-sm"
                               Placeholder="#000000" />
                    </div>
                </div>

                @* RGB Inputs *@
                <div class="grid @(ShowAlpha ? "grid-cols-4" : "grid-cols-3") gap-2">
                    <div>
                        <label class="text-xs text-muted-foreground">R</label>
                        <BbInput Value="@_r.ToString()"
                               ValueChanged="@(v => HandleRgbInput(v, 'r'))"
                               Class="text-sm text-center" />
                    </div>
                    <div>
                        <label class="text-xs text-muted-foreground">G</label>
                        <BbInput Value="@_g.ToString()"
                               ValueChanged="@(v => HandleRgbInput(v, 'g'))"
                               Class="text-sm text-center" />
                    </div>
                    <div>
                        <label class="text-xs text-muted-foreground">B</label>
                        <BbInput Value="@_b.ToString()"
                               ValueChanged="@(v => HandleRgbInput(v, 'b'))"
                               Class="text-sm text-center" />
                    </div>
                    @if (ShowAlpha)
                    {
                        <div>
                            <label class="text-xs text-muted-foreground">A</label>
                            <BbInput Value="@($"{(int)Math.Round(_alpha * 100)}%")"
                                   ValueChanged="HandleAlphaInput"
                                   Class="text-sm text-center" />
                        </div>
                    }
                </div>
            }

            @* Preset Colors *@
            @if (ShowPresets)
            {
                <div class="space-y-2">
                    <span class="text-xs text-muted-foreground">Presets</span>
                    <div class="flex flex-wrap gap-1">
                        @foreach (var preset in EffectivePresets)
                        {
                            <button type="button"
                                    class="h-6 w-6 rounded border border-input cursor-pointer hover:scale-110 transition-transform"
                                    style="background-color: @preset;"
                                    @onclick="() => SelectPreset(preset)"
                                    title="@preset">
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    </BbPopoverContent>
</BbPopover>

@code {
    private bool _isOpen;
    private double _hue;
    private double _saturation;
    private double _brightness;
    private double _alpha = 1;
    private int _r, _g, _b;
    private string _hexInput = "#000000";
    private string? _previousValue;
    private long? _activeAreaPointerId;
    private long? _activeHuePointerId;
    private long? _activeAlphaPointerId;
    private FieldIdentifier _fieldIdentifier;
    private EditContext? _editContext;

    [CascadingParameter]
    private EditContext? CascadedEditContext { get; set; }

    private static readonly string[] DefaultPresets = {
        "#000000", "#FFFFFF", "#FF0000", "#00FF00", "#0000FF",
        "#FFFF00", "#FF00FF", "#00FFFF", "#FF6600", "#6600FF",
        "#808080", "#C0C0C0", "#800000", "#008000", "#000080"
    };

    /// <summary>
    /// Gets or sets the color value in hex format.
    /// </summary>
    [Parameter]
    public string Value { get; set; } = "#000000";

    /// <summary>
    /// Callback when the color changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the initial color value for uncontrolled usage.
    /// When set, this value is used as the starting color on first render.
    /// </summary>
    [Parameter]
    public string? DefaultValue { get; set; }

    /// <summary>
    /// Gets or sets the color format for output.
    /// </summary>
    [Parameter]
    public ColorFormat Format { get; set; } = ColorFormat.Hex;

    /// <summary>
    /// Gets or sets whether to show the alpha slider.
    /// </summary>
    [Parameter]
    public bool ShowAlpha { get; set; }

    /// <summary>
    /// Gets or sets whether to show preset colors.
    /// </summary>
    [Parameter]
    public bool ShowPresets { get; set; } = true;

    /// <summary>
    /// Gets or sets custom preset colors.
    /// </summary>
    [Parameter]
    public string[]? PresetColors { get; set; }

    /// <summary>
    /// Gets or sets whether to show color inputs.
    /// </summary>
    [Parameter]
    public bool ShowInputs { get; set; } = true;

    /// <summary>
    /// Gets or sets whether the picker is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets additional CSS classes for the trigger button.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Gets or sets an expression that identifies the bound value.
    /// </summary>
    [Parameter]
    public Expression<Func<string>>? ValueExpression { get; set; }

    private string[] EffectivePresets => PresetColors ?? DefaultPresets;

    private string CurrentColorWithoutAlpha => ColorUtils.ToHex(_r, _g, _b);

    private string DisplayValue
    {
        get
        {
            if (!ShowAlpha) return Value;
            var hex = ColorUtils.ToHex(_r, _g, _b);
            return _alpha < 1 ? $"{hex} {(int)Math.Round(_alpha * 100)}%" : hex;
        }
    }

    protected override void OnInitialized()
    {
        if (DefaultValue != null && ColorUtils.IsValidHex(DefaultValue))
        {
            Value = DefaultValue;
        }

        ParseValue(Value);
        _previousValue = Value;
    }

    protected override void OnParametersSet()
    {
        if (Value != _previousValue && ColorUtils.IsValidHex(Value))
        {
            ParseValue(Value);
            _previousValue = Value;
        }

        if (CascadedEditContext != null && ValueExpression != null)
        {
            _editContext = CascadedEditContext;
            _fieldIdentifier = FieldIdentifier.Create(ValueExpression);
        }
    }

    private void ParseValue(string hex)
    {
        if (!ColorUtils.IsValidHex(hex)) return;

        var (r, g, b, a) = ColorUtils.ParseHex(hex);
        _r = r;
        _g = g;
        _b = b;
        _alpha = a.HasValue ? a.Value / 255.0 : 1;

        var (h, s, v) = ColorUtils.RgbToHsv(r, g, b);
        _hue = h;
        _saturation = s;
        _brightness = v;

        _hexInput = ColorUtils.ToHex(_r, _g, _b);
    }

    private async Task UpdateColor()
    {
        var (r, g, b) = ColorUtils.HsvToRgb(_hue, _saturation, _brightness);
        _r = r;
        _g = g;
        _b = b;

        var alphaInt = ShowAlpha ? (int)Math.Round(_alpha * 255) : (int?)null;

        var newValue = Format switch
        {
            ColorFormat.RGB => ColorUtils.ToRgbString(r, g, b, alphaInt),
            ColorFormat.HSL => ColorUtils.ToHslString(_hue, _saturation, _brightness * (1 - _saturation / 2), alphaInt),
            _ => ColorUtils.ToHex(r, g, b, alphaInt)
        };

        _hexInput = ColorUtils.ToHex(r, g, b);

        _previousValue = newValue;
        Value = newValue;
        await ValueChanged.InvokeAsync(newValue);

        if (_editContext != null && ValueExpression != null && _fieldIdentifier.FieldName != null)
        {
            _editContext.NotifyFieldChanged(_fieldIdentifier);
        }

        StateHasChanged();
    }

    // Area (Saturation/Brightness) handlers
    private async Task HandleAreaPointerDown(PointerEventArgs e)
    {
        if (_activeAreaPointerId.HasValue) return; // Ignore multi-touch
        _activeAreaPointerId = e.PointerId;
        await UpdateAreaPosition(e);
    }

    private async Task HandleAreaPointerMove(PointerEventArgs e)
    {
        if (_activeAreaPointerId != e.PointerId) return;
        await UpdateAreaPosition(e);
    }

    private void HandleAreaPointerUp(PointerEventArgs e)
    {
        if (_activeAreaPointerId == e.PointerId)
        {
            _activeAreaPointerId = null;
        }
    }

    private void HandleAreaPointerLeave(PointerEventArgs e)
    {
        if (_activeAreaPointerId == e.PointerId)
        {
            _activeAreaPointerId = null;
        }
    }

    private void HandleAreaPointerCancel(PointerEventArgs e)
    {
        if (_activeAreaPointerId == e.PointerId)
        {
            _activeAreaPointerId = null;
        }
    }

    private async Task UpdateAreaPosition(PointerEventArgs e)
    {
        // Approximate position based on offset
        _saturation = Math.Max(0, Math.Min(1, e.OffsetX / 248)); // Account for padding
        _brightness = Math.Max(0, Math.Min(1, 1 - e.OffsetY / 150));
        await UpdateColor();
    }

    // Hue slider handlers
    private async Task HandleHuePointerDown(PointerEventArgs e)
    {
        if (_activeHuePointerId.HasValue) return; // Ignore multi-touch
        _activeHuePointerId = e.PointerId;
        await UpdateHuePosition(e);
    }

    private async Task HandleHuePointerMove(PointerEventArgs e)
    {
        if (_activeHuePointerId != e.PointerId) return;
        await UpdateHuePosition(e);
    }

    private void HandleHuePointerUp(PointerEventArgs e)
    {
        if (_activeHuePointerId == e.PointerId)
        {
            _activeHuePointerId = null;
        }
    }

    private void HandleHuePointerLeave(PointerEventArgs e)
    {
        if (_activeHuePointerId == e.PointerId)
        {
            _activeHuePointerId = null;
        }
    }

    private void HandleHuePointerCancel(PointerEventArgs e)
    {
        if (_activeHuePointerId == e.PointerId)
        {
            _activeHuePointerId = null;
        }
    }

    private async Task UpdateHuePosition(PointerEventArgs e)
    {
        _hue = Math.Max(0, Math.Min(360, (e.OffsetX / 248) * 360));
        await UpdateColor();
    }

    // Alpha slider handlers
    private async Task HandleAlphaPointerDown(PointerEventArgs e)
    {
        if (_activeAlphaPointerId.HasValue) return; // Ignore multi-touch
        _activeAlphaPointerId = e.PointerId;
        await UpdateAlphaPosition(e);
    }

    private async Task HandleAlphaPointerMove(PointerEventArgs e)
    {
        if (_activeAlphaPointerId != e.PointerId) return;
        await UpdateAlphaPosition(e);
    }

    private void HandleAlphaPointerUp(PointerEventArgs e)
    {
        if (_activeAlphaPointerId == e.PointerId)
        {
            _activeAlphaPointerId = null;
        }
    }

    private void HandleAlphaPointerLeave(PointerEventArgs e)
    {
        if (_activeAlphaPointerId == e.PointerId)
        {
            _activeAlphaPointerId = null;
        }
    }

    private void HandleAlphaPointerCancel(PointerEventArgs e)
    {
        if (_activeAlphaPointerId == e.PointerId)
        {
            _activeAlphaPointerId = null;
        }
    }

    private async Task UpdateAlphaPosition(PointerEventArgs e)
    {
        _alpha = Math.Max(0, Math.Min(1, e.OffsetX / 248));
        await UpdateColor();
    }

    private async Task HandleHexInput(string? value)
    {
        if (string.IsNullOrEmpty(value)) return;

        var hex = value.StartsWith("#") ? value : $"#{value}";
        if (!ColorUtils.IsValidHex(hex)) return;

        ParseValue(hex);
        await UpdateColor();
    }

    private async Task HandleRgbInput(string? value, char component)
    {
        if (!int.TryParse(value, out var v)) return;
        v = Math.Max(0, Math.Min(255, v));

        switch (component)
        {
            case 'r': _r = v; break;
            case 'g': _g = v; break;
            case 'b': _b = v; break;
        }

        var (h, s, bv) = ColorUtils.RgbToHsv(_r, _g, _b);
        _hue = h;
        _saturation = s;
        _brightness = bv;

        await UpdateColor();
    }

    private async Task SelectPreset(string color)
    {
        ParseValue(color);
        await UpdateColor();
    }

    private async Task HandleAlphaInput(string? value)
    {
        if (string.IsNullOrEmpty(value)) return;
        value = value.TrimEnd('%');
        if (!int.TryParse(value, out var v)) return;
        _alpha = Math.Max(0, Math.Min(1, v / 100.0));
        await UpdateColor();
    }

    private string ButtonClass => ClassNames.cn(
        "w-[180px] justify-start",
        Disabled ? "opacity-50 pointer-events-none" : null,
        Class
    );
}
