@namespace BlazorBlueprint.Components
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager NavigationManager
@implements IDisposable

@*
    Navigation Menu component - primary site navigation.
    Provides a horizontal navigation bar with dropdown support.
*@

<nav class="@CssClass" @attributes="AdditionalAttributes">
    <CascadingValue Value="@this" IsFixed="true">
        @ChildContent
    </CascadingValue>
</nav>

@code {
    private string? _activeItem;
    private CancellationTokenSource? _closeTimerCts;
    private List<ElementReference> _triggerRefs = new();

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Close any open menu when navigation occurs
        if (_activeItem != null)
        {
            _activeItem = null;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        _closeTimerCts?.Dispose();
    }

    /// <summary>
    /// The content to render inside the navigation menu.
    /// Typically contains NavigationMenuList components.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the navigation menu.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional attributes to apply to the navigation menu.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Enables keyboard navigation within dropdown menus.
    /// When true, users can navigate items with arrow keys.
    /// Default is false.
    /// </summary>
    [Parameter]
    public bool EnableKeyboardNavigation { get; set; } = false;

    /// <summary>
    /// Gets or sets the currently active/open menu item.
    /// </summary>
    internal string? ActiveItem
    {
        get => _activeItem;
        set
        {
            _activeItem = value;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Registers a trigger element for keyboard navigation.
    /// </summary>
    internal int RegisterTrigger(ElementReference triggerRef)
    {
        _triggerRefs.Add(triggerRef);
        return _triggerRefs.Count - 1;
    }

    /// <summary>
    /// Gets the trigger element at the specified index.
    /// </summary>
    internal ElementReference? GetTriggerAt(int index)
    {
        if (index >= 0 && index < _triggerRefs.Count)
        {
            return _triggerRefs[index];
        }
        return null;
    }

    /// <summary>
    /// Gets the total number of registered triggers.
    /// </summary>
    internal int TriggerCount => _triggerRefs.Count;

    /// <summary>
    /// Starts a shared timer to close the menu after a short delay.
    /// This is shared across all menu items to prevent race conditions.
    /// </summary>
    internal async void StartCloseTimer()
    {
        CancelCloseTimer();
        _closeTimerCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(150, _closeTimerCts.Token);
            ActiveItem = null;
        }
        catch (TaskCanceledException)
        {
            // Timer was cancelled, do nothing
        }
    }

    /// <summary>
    /// Cancels any pending close timer.
    /// </summary>
    internal void CancelCloseTimer()
    {
        _closeTimerCts?.Cancel();
        _closeTimerCts?.Dispose();
        _closeTimerCts = null;
    }

    /// <summary>
    /// Gets the computed CSS classes for the navigation menu.
    /// </summary>
    private string CssClass => ClassNames.cn(
        "relative flex max-w-max flex-1 items-center justify-center",
        _activeItem != null ? "z-50" : "z-10",
        Class
    );
}
