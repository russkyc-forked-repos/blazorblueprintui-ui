@namespace BlazorBlueprint.Components

@*
    Navigation Menu Item - a single item in the navigation menu.
    Can contain a trigger (for dropdowns) or a link.
*@

<li class="@CssClass">
    <CascadingValue Value="@this" IsFixed="true">
        @ChildContent
    </CascadingValue>
</li>

@code {
    private BbNavigationMenuTrigger? _trigger;
    private BbNavigationMenuContent? _content;

    /// <summary>
    /// Reference to the parent navigation menu.
    /// </summary>
    [CascadingParameter]
    public BbNavigationMenu? Menu { get; set; }

    /// <summary>
    /// The content of the menu item.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Unique identifier for this menu item.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the item.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Gets whether this item is currently open.
    /// </summary>
    internal bool IsOpen
    {
        get => Menu?.ActiveItem == Value;
        set
        {
            if (Menu != null)
            {
                Menu.ActiveItem = value ? Value : null;
            }
        }
    }

    /// <summary>
    /// Registers the trigger component for focus management.
    /// </summary>
    internal void RegisterTrigger(BbNavigationMenuTrigger trigger)
    {
        _trigger = trigger;
    }

    /// <summary>
    /// Registers the content component for focus management.
    /// </summary>
    internal void RegisterContent(BbNavigationMenuContent content)
    {
        _content = content;
    }

    /// <summary>
    /// Focuses the trigger element.
    /// </summary>
    internal async Task FocusTriggerAsync()
    {
        if (_trigger != null)
        {
            await _trigger.FocusAsync();
        }
    }

    /// <summary>
    /// Focuses the first item in the content.
    /// </summary>
    internal async Task FocusFirstContentItemAsync()
    {
        if (_content != null)
        {
            await _content.FocusFirstItemAsync();
        }
    }

    /// <summary>
    /// Toggles the open state of this menu item.
    /// </summary>
    internal void Toggle()
    {
        IsOpen = !IsOpen;
    }

    /// <summary>
    /// Starts a timer to close the menu after a short delay.
    /// Delegates to the parent menu's shared timer.
    /// </summary>
    internal void StartCloseTimer()
    {
        Menu?.StartCloseTimer();
    }

    /// <summary>
    /// Cancels any pending close timer.
    /// Delegates to the parent menu's shared timer.
    /// </summary>
    internal void CancelCloseTimer()
    {
        Menu?.CancelCloseTimer();
    }

    /// <summary>
    /// Gets the computed CSS classes for the item.
    /// </summary>
    private string CssClass => ClassNames.cn(
        "relative",
        IsOpen ? "z-50" : null,
        Class
    );
}
