@namespace BlazorBlueprint.Components
@using BlazorBlueprint.Icons.Lucide.Components

@*
    Individual Toast component - displays a single toast notification.
*@

<div class="@CssClass" role="alert"
     @onmouseenter="HandleMouseEnter"
     @onmouseleave="HandleMouseLeave">

    @if (ShouldShowIcon)
    {
        <div class="shrink-0">
            <LucideIcon Name="@IconName" Class="@IconCssClass" />
        </div>
    }

    <div class="@ContentCssClass">
        @if (!string.IsNullOrEmpty(Data.Title))
        {
            <div class="@TitleCssClass">@Data.Title</div>
        }
        @if (!string.IsNullOrEmpty(Data.Description))
        {
            <div class="@DescriptionCssClass">@Data.Description</div>
        }
    </div>

    @if (!string.IsNullOrEmpty(Data.ActionText) && Data.OnAction != null)
    {
        <button type="button"
                class="@ActionCssClass"
                @onclick="HandleAction">
            @Data.ActionText
        </button>
    }

    @if (Data.ShowClose)
    {
        <button type="button"
                class="@CloseCssClass"
                @onclick="HandleClose">
            <LucideIcon Name="x" Class="h-4 w-4" />
            <span class="sr-only">Close</span>
        </button>
    }
</div>

@code {
    /// <summary>
    /// The toast data to display.
    /// </summary>
    [Parameter, EditorRequired]
    public ToastData Data { get; set; } = default!;

    /// <summary>
    /// Callback when the toast should be dismissed.
    /// </summary>
    [Parameter]
    public EventCallback OnDismiss { get; set; }

    /// <summary>
    /// Callback when auto-dismiss should pause (mouse enter).
    /// </summary>
    [Parameter]
    public EventCallback OnPause { get; set; }

    /// <summary>
    /// Callback when auto-dismiss should resume (mouse leave).
    /// </summary>
    [Parameter]
    public EventCallback OnResume { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the toast.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    private async Task HandleClose()
    {
        await OnDismiss.InvokeAsync();
    }

    private async Task HandleAction()
    {
        Data.OnAction?.Invoke();
        await OnDismiss.InvokeAsync();
    }

    private async Task HandleMouseEnter()
    {
        if (OnPause.HasDelegate)
        {
            await OnPause.InvokeAsync();
        }
    }

    private async Task HandleMouseLeave()
    {
        if (OnResume.HasDelegate)
        {
            await OnResume.InvokeAsync();
        }
    }

    private bool ShouldShowIcon => Data.ShowIcon && Data.Variant != ToastVariant.Default;

    private string IconName => Data.Variant switch
    {
        ToastVariant.Success => "circle-check",
        ToastVariant.Info => "info",
        ToastVariant.Warning => "triangle-alert",
        ToastVariant.Destructive => "circle-x",
        _ => ""
    };

    private bool IsCompact => Data.Size == ToastSize.Compact;

    /// <summary>
    /// Gets the computed CSS classes for the toast.
    /// </summary>
    private string CssClass => ClassNames.cn(
        "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border shadow-lg transition-all",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-80",
        "data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full",
        "data-[state=open]:sm:slide-in-from-bottom-full",
        IsCompact
            ? Data.ShowClose ? "p-3 pr-6" : "p-3"
            : Data.ShowClose ? "p-6 pr-8" : "p-6",
        Data.Variant switch
        {
            ToastVariant.Default => "border bg-background text-foreground",
            ToastVariant.Success => "border-alert-success/30 bg-alert-success-bg text-alert-success-foreground",
            ToastVariant.Info => "border-alert-info/30 bg-alert-info-bg text-alert-info-foreground",
            ToastVariant.Warning => "border-alert-warning/30 bg-alert-warning-bg text-alert-warning-foreground",
            ToastVariant.Destructive => "destructive group border-destructive bg-destructive text-destructive-foreground",
            _ => "border bg-background text-foreground"
        },
        Class
    );

    private string IconCssClass => ClassNames.cn(
        IsCompact ? "h-4 w-4" : "h-5 w-5",
        Data.Variant switch
        {
            ToastVariant.Success => "text-alert-success",
            ToastVariant.Info => "text-alert-info",
            ToastVariant.Warning => "text-alert-warning",
            ToastVariant.Destructive => "text-destructive-foreground",
            _ => ""
        }
    );

    private string ContentCssClass => ClassNames.cn(
        "grid flex-1",
        IsCompact ? "gap-0.5" : "gap-1"
    );

    private string TitleCssClass => IsCompact ? "text-xs font-semibold" : "text-sm font-semibold";

    private string DescriptionCssClass => ClassNames.cn(
        IsCompact ? "text-xs" : "text-sm",
        "opacity-90"
    );

    private string ActionCssClass => ClassNames.cn(
        "inline-flex shrink-0 items-center justify-center rounded-md border bg-transparent font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
        IsCompact ? "h-7 px-2 text-xs" : "h-8 px-3 text-sm"
    );

    /// <summary>
    /// Gets the computed CSS classes for the close button.
    /// </summary>
    private string CloseCssClass => ClassNames.cn(
        "absolute rounded-md p-1 opacity-0 transition-opacity",
        "hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100",
        IsCompact ? "right-1 top-1" : "right-2 top-2",
        Data.Variant == ToastVariant.Destructive
            ? "text-red-300 hover:text-red-50 focus:ring-red-400 focus:ring-offset-red-600"
            : "text-foreground/50 hover:text-foreground focus:ring-ring"
    );
}
