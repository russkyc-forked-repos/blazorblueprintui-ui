@namespace BlazorBlueprint.Components
@typeparam TValue
@attribute [CascadingTypeParameter(nameof(TValue))]

<div role="group" class="@CssClass">
    <CascadingValue Value="this" IsFixed="true">
        @ChildContent
    </CascadingValue>
</div>

@code {
    [Parameter]
    public TValue? Value { get; set; }

    [Parameter]
    public EventCallback<TValue?> ValueChanged { get; set; }

    [Parameter]
    public TValue? DefaultValue { get; set; }

    [Parameter]
    public ToggleGroupType Type { get; set; } = ToggleGroupType.Single;

    [Parameter]
    public List<TValue>? Values { get; set; }

    [Parameter]
    public EventCallback<List<TValue>> ValuesChanged { get; set; }

    [Parameter]
    public ToggleVariant Variant { get; set; } = ToggleVariant.Default;

    [Parameter]
    public ToggleSize Size { get; set; } = ToggleSize.Default;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private TValue? _internalValue;
    private List<TValue> _internalValues = new();
    private bool IsControlled => ValueChanged.HasDelegate || ValuesChanged.HasDelegate;

    protected override void OnInitialized()
    {
        _internalValue = DefaultValue;
    }

    internal bool IsItemPressed(TValue? itemValue)
    {
        if (itemValue == null) return false;

        if (Type == ToggleGroupType.Single)
        {
            var currentValue = IsControlled ? Value : _internalValue;
            return EqualityComparer<TValue>.Default.Equals(currentValue, itemValue);
        }
        else
        {
            var currentValues = IsControlled ? Values : _internalValues;
            return currentValues?.Contains(itemValue) == true;
        }
    }

    internal async Task ToggleItem(TValue? itemValue)
    {
        if (itemValue == null || Disabled) return;

        if (Type == ToggleGroupType.Single)
        {
            var currentValue = IsControlled ? Value : _internalValue;
            var newValue = EqualityComparer<TValue>.Default.Equals(currentValue, itemValue) ? default : itemValue;

            if (IsControlled)
            {
                await ValueChanged.InvokeAsync(newValue);
            }
            else
            {
                _internalValue = newValue;
                StateHasChanged();
            }
        }
        else
        {
            var currentValues = (IsControlled ? Values : _internalValues) ?? new List<TValue>();
            var newValues = new List<TValue>(currentValues);

            if (newValues.Contains(itemValue))
            {
                newValues.Remove(itemValue);
            }
            else
            {
                newValues.Add(itemValue);
            }

            if (IsControlled)
            {
                await ValuesChanged.InvokeAsync(newValues);
            }
            else
            {
                _internalValues = newValues;
                StateHasChanged();
            }
        }
    }

    private string CssClass => ClassNames.cn(
        "flex items-center justify-center gap-1",
        Class
    );
}
