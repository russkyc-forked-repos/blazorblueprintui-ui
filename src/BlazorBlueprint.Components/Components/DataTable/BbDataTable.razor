@namespace BlazorBlueprint.Components
@typeparam TData where TData : class

<CascadingValue Value="this" IsFixed="true">
    <div class="@ContainerCssClass">
        @if (ShowToolbar)
        {
            <BbDataTableToolbar TData="TData"
                              GlobalSearchValue="@_globalSearchValue"
                              OnGlobalSearchChanged="HandleGlobalSearchChanged"
                              Columns="@_columns"
                              OnColumnVisibilityChanged="HandleColumnVisibilityChanged">
                @ToolbarActions
            </BbDataTableToolbar>
        }

        <div class="@TableContainerCssClass">
            @if (IsLoading)
            {
                @if (LoadingTemplate != null)
                {
                    @LoadingTemplate
                }
                else
                {
                    <div class="flex items-center justify-center p-8 text-muted-foreground">
                        <div class="text-sm">Loading...</div>
                    </div>
                }
            }
            else if (!_processedData.Any())
            {
                @if (EmptyTemplate != null)
                {
                    @EmptyTemplate
                }
                else
                {
                    <BbEmpty Title="No results found" Size="EmptySize.Small" />
                }
            }
            else
            {
                <BlazorBlueprint.Primitives.Table.BbTable TData="TData"
                                                 Data="@_processedData"
                                                 @bind-State="@_tableState"
                                                 SelectionMode="@GetPrimitiveSelectionMode()"
                                                 ManualPagination="true"
                                                 EnableKeyboardNavigation="@EnableKeyboardNavigation"
                                                 OnSortChange="HandleSortChange"
                                                 OnSelectionChange="HandleSelectionChange"
                                                 Class="@TableCssClass"
                                                 AriaLabel="@AriaLabel">
                    <BlazorBlueprint.Primitives.Table.BbTableHeader>
                        <BlazorBlueprint.Primitives.Table.BbTableRow TData="TData" Class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                            @if (SelectionMode == DataTableSelectionMode.Multiple)
                            {
                                <BlazorBlueprint.Primitives.Table.BbTableHeaderCell TData="TData" Class="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12" role="columnheader">
                                    <div @onclick:stopPropagation="true">
                                        @if (ShouldShowSelectAllPrompt())
                                        {
                                            <BbDropdownMenu @bind-Open="_selectAllDropdownOpen">
                                                <BbDropdownMenuTrigger AsChild="false" Class="inline-flex items-center justify-center p-0 bg-transparent border-0 hover:bg-transparent focus:outline-none">
                                                    <BbCheckbox Checked="@IsAllSelected()"
                                                              Indeterminate="@IsSomeSelected()"
                                                              AriaLabel="Select rows - click to see options"
                                                              Class="pointer-events-none" />
                                                </BbDropdownMenuTrigger>
                                                <BbDropdownMenuContent Side="PopoverSide.Bottom" Align="PopoverAlign.Start">
                                                    <BbDropdownMenuItem OnClick="@HandleSelectAllOnCurrentPage">
                                                        Select all on this page (@_processedData.Count() items)
                                                    </BbDropdownMenuItem>
                                                    <BbDropdownMenuItem OnClick="@HandleSelectAllItems">
                                                        Select all @GetTotalFilteredItemCount() items
                                                    </BbDropdownMenuItem>
                                                    @if (_tableState.Selection.HasSelection)
                                                    {
                                                        <BbDropdownMenuSeparator />
                                                        <BbDropdownMenuItem OnClick="@HandleClearSelection">
                                                            Clear selection
                                                        </BbDropdownMenuItem>
                                                    }
                                                </BbDropdownMenuContent>
                                            </BbDropdownMenu>
                                        }
                                        else
                                        {
                                            <BbCheckbox Checked="@IsAllSelected()"
                                                      CheckedChanged="@(async (bool isChecked) => await HandleSelectAllChanged(isChecked))"
                                                      Indeterminate="@IsSomeSelected()"
                                                      AriaLabel="Select all rows" />
                                        }
                                    </div>
                                </BlazorBlueprint.Primitives.Table.BbTableHeaderCell>
                            }
                            @foreach (var column in _columns.Where(c => c.Visible))
                            {
                                var ariaSortValue = column.Sortable && _tableState.Sorting.SortedColumn == column.Id
                                    ? (_tableState.Sorting.Direction == SortDirection.Ascending ? "ascending" : "descending")
                                    : (column.Sortable ? "none" : null);

                                <BlazorBlueprint.Primitives.Table.BbTableHeaderCell TData="TData" ColumnId="@(column.Sortable ? column.Id : null)"
                                                 Class="@ClassNames.cn("h-12 px-4 text-left align-middle font-medium text-muted-foreground", column.Sortable ? "cursor-pointer select-none" : "", column.HeaderClass)"
                                                 style="@GetColumnWidthStyle(column)"
                                                 aria-sort="@ariaSortValue">
                                    <div class="flex items-center gap-2">
                                        <span>@column.Header</span>
                                        @if (column.Sortable && _tableState.Sorting.SortedColumn == column.Id)
                                        {
                                            @if (_tableState.Sorting.Direction == SortDirection.Ascending)
                                            {
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                                </svg>
                                            }
                                            else if (_tableState.Sorting.Direction == SortDirection.Descending)
                                            {
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                </svg>
                                            }
                                        }
                                        else if (column.Sortable)
                                        {
                                            <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                            </svg>
                                        }
                                    </div>
                                </BlazorBlueprint.Primitives.Table.BbTableHeaderCell>
                            }
                        </BlazorBlueprint.Primitives.Table.BbTableRow>
                    </BlazorBlueprint.Primitives.Table.BbTableHeader>
                    <BlazorBlueprint.Primitives.Table.BbTableBody>
                        @foreach (var item in _processedData)
                        {
                            var isSelected = _tableState.Selection.IsSelected(item);
                            <BlazorBlueprint.Primitives.Table.BbTableRow TData="TData" Item="@item" Class="@ClassNames.cn("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted", isSelected ? "bg-muted" : "")">
                                @if (SelectionMode == DataTableSelectionMode.Multiple)
                                {
                                    <BlazorBlueprint.Primitives.Table.BbTableCell Class="p-4 align-middle w-12" role="gridcell">
                                        <div @onclick:stopPropagation="true">
                                            <BbCheckbox Checked="@isSelected"
                                                      CheckedChanged="@(async (bool isChecked) => await HandleRowSelectionChanged(item, isChecked))"
                                                      AriaLabel="@($"Select this row")" />
                                        </div>
                                    </BlazorBlueprint.Primitives.Table.BbTableCell>
                                }
                                @foreach (var column in _columns.Where(c => c.Visible))
                                {
                                    <BlazorBlueprint.Primitives.Table.BbTableCell Class="@ClassNames.cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", column.CellClass)">
                                        @if (column.CellTemplate != null)
                                        {
                                            @column.CellTemplate(item)
                                        }
                                        else if (column.Property != null)
                                        {
                                            var value = column.Property(item);
                                            @(value is IFormattable formattable && column.Format is not null ? formattable.ToString(column.Format, null) : value?.ToString() ?? "")
                                        }
                                    </BlazorBlueprint.Primitives.Table.BbTableCell>
                                }
                            </BlazorBlueprint.Primitives.Table.BbTableRow>
                        }
                    </BlazorBlueprint.Primitives.Table.BbTableBody>
                </BlazorBlueprint.Primitives.Table.BbTable>
            }
        </div>

        @if (ShowPagination && !IsLoading && _processedData.Any())
        {
            <BbPagination State="@_tableState.Pagination"
                        PageSizes="@PageSizes"
                        OnPageChanged="@HandlePageChanged"
                        OnPageSizeChanged="@HandlePageSizeChanged"
                        Class="flex items-center justify-between px-2 py-4">
                <BbPaginationInfo />
                <BbPaginationContent Class="flex items-center gap-6 lg:gap-8">
                    <BbPaginationPageSizeSelector />
                    <div class="flex items-center gap-2">
                        <BbPaginationPageDisplay />
                        <div class="flex items-center gap-1">
                            <BbPaginationItem><BbPaginationFirst /></BbPaginationItem>
                            <BbPaginationItem><BbPaginationPrevious ShowText="false" /></BbPaginationItem>
                            <BbPaginationItem><BbPaginationNext ShowText="false" /></BbPaginationItem>
                            <BbPaginationItem><BbPaginationLast /></BbPaginationItem>
                        </div>
                    </div>
                </BbPaginationContent>
            </BbPagination>
        }
    </div>

    @* Capture column definitions *@
    @Columns
</CascadingValue>
