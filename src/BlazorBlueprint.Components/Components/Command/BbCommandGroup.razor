@namespace BlazorBlueprint.Components
@implements IDisposable

<CascadingValue Value="Id" Name="CommandGroupId">
    <div class="@CssClass"
         style="@(_isVisible ? null : "display: none")"
         role="group"
         aria-labelledby="@(string.IsNullOrWhiteSpace(Heading) ? null : $"command-group-{Id}")">
        @if (!string.IsNullOrWhiteSpace(Heading))
        {
            <div id="@($"command-group-{Id}")"
                 class="px-2 py-1.5 text-xs font-medium text-muted-foreground">
                @Heading
            </div>
        }
        @ChildContent
    </div>
</CascadingValue>

@code {
    [CascadingParameter]
    public CommandContext? Context { get; set; }

    /// <summary>
    /// Gets or sets additional CSS classes to apply to the group container.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Gets or sets the heading text for this group (optional).
    /// </summary>
    [Parameter]
    public string? Heading { get; set; }

    /// <summary>
    /// Gets or sets the content to be rendered inside the group.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets the unique identifier for this group.
    /// </summary>
    private string Id { get; } = Guid.NewGuid().ToString("N");

    private bool _isVisible = true;

    /// <summary>
    /// Gets the computed CSS classes for the group container.
    /// </summary>
    private string CssClass => ClassNames.cn(
        "overflow-hidden p-1 text-foreground",
        "[&_[data-command-group-heading]]:px-2 [&_[data-command-group-heading]]:py-1.5",
        "[&_[data-command-group-heading]]:text-xs [&_[data-command-group-heading]]:font-medium",
        "[&_[data-command-group-heading]]:text-muted-foreground",
        Class
    );

    protected override void OnInitialized()
    {
        if (Context != null)
        {
            Context.OnStateChanged += HandleContextStateChanged;
        }
    }

    private void HandleContextStateChanged()
    {
        if (Context == null) return;

        // Show the group only if it has visible items (items that pass the current filter)
        _isVisible = Context.GroupHasVisibleItems(Id);
        StateHasChanged();
    }

    public void Dispose()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }
    }
}
