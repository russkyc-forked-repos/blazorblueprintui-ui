@namespace BlazorBlueprint.Components
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<div @ref="_trackRef"
     role="slider"
     aria-valuemin="@Min"
     aria-valuemax="@Max"
     aria-valuenow="@CurrentValue"
     aria-disabled="@Disabled"
     tabindex="@(Disabled ? -1 : 0)"
     class="@CssClass"
     @onkeydown="HandleKeyDown">
    <div class="@ComputedTrackClass">
        <div class="@ComputedIndicatorClass"
             style="width: @(Percentage)%;">
        </div>
    </div>
    <div class="@ComputedThumbClass"
         style="left: @(Percentage)%;">
    </div>
</div>

@code {
    [Parameter]
    public double Value { get; set; }

    [Parameter]
    public EventCallback<double> ValueChanged { get; set; }

    [Parameter]
    public double DefaultValue { get; set; }

    [Parameter]
    public double Min { get; set; } = 0;

    [Parameter]
    public double Max { get; set; } = 100;

    [Parameter]
    public double Step { get; set; } = 1;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public SliderOrientation Orientation { get; set; } = SliderOrientation.Horizontal;

    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the slider track.
    /// </summary>
    [Parameter]
    public string? TrackClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the slider thumb.
    /// </summary>
    [Parameter]
    public string? ThumbClass { get; set; }

    private ElementReference _trackRef;
    private double _internalValue;
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<BbSlider>? _dotNetRef;
    private string _sliderId = Guid.NewGuid().ToString("N");
    private bool _jsInitialized;
    private bool _disposed;

    private bool IsControlled => ValueChanged.HasDelegate;
    private double CurrentValue => IsControlled ? Value : _internalValue;
    private double Percentage => ((CurrentValue - Min) / (Max - Min)) * 100;

    protected override void OnInitialized()
    {
        _internalValue = DefaultValue;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !Disabled)
        {
            await InitializeJsAsync();
        }
    }

    private async Task InitializeJsAsync()
    {
        if (_jsInitialized) return;

        try
        {
            _jsModule = await JS.InvokeAsync<IJSObjectReference>("import",
                "./_content/BlazorBlueprint.Components/js/slider.js");
            _dotNetRef = DotNetObjectReference.Create(this);
            await _jsModule.InvokeVoidAsync("initializeSlider", _trackRef, _dotNetRef, _sliderId);
            _jsInitialized = true;
        }
        catch (JSDisconnectedException)
        {
            // Expected during circuit disconnect in Blazor Server
        }
        catch (InvalidOperationException)
        {
            // JS interop not available during prerendering
        }
    }

    [JSInvokable]
    public async Task UpdateValueFromPercentage(double percentage)
    {
        if (_disposed) return;
        if (Disabled) return;

        // Input validation - reject invalid values
        if (double.IsNaN(percentage) || double.IsInfinity(percentage))
            return;

        // Clamp percentage to valid range
        percentage = Math.Max(0, Math.Min(1, percentage));

        var newValue = Min + (percentage * (Max - Min));
        await SetValue(newValue);
    }

    private async Task SetValue(double value)
    {
        value = Math.Round(value / Step) * Step;
        value = Math.Max(Min, Math.Min(Max, value));

        if (IsControlled)
        {
            await ValueChanged.InvokeAsync(value);
        }
        else
        {
            _internalValue = value;
            StateHasChanged();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Disabled) return;

        var stepSize = Step;
        var largeStep = (Max - Min) / 10;

        switch (e.Key)
        {
            case "ArrowRight":
            case "ArrowUp":
                await SetValue(CurrentValue + stepSize);
                break;
            case "ArrowLeft":
            case "ArrowDown":
                await SetValue(CurrentValue - stepSize);
                break;
            case "PageUp":
                await SetValue(CurrentValue + largeStep);
                break;
            case "PageDown":
                await SetValue(CurrentValue - largeStep);
                break;
            case "Home":
                await SetValue(Min);
                break;
            case "End":
                await SetValue(Max);
                break;
        }
    }

    private string CssClass => ClassNames.cn(
        "relative flex w-full touch-none select-none items-center",
        Disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer",
        Class
    );

    private string ComputedTrackClass => ClassNames.cn(
        "relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",
        TrackClass
    );

    private string ComputedIndicatorClass => "absolute h-full bg-primary";

    private string ComputedThumbClass => ClassNames.cn(
        "absolute block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
        "disabled:pointer-events-none disabled:opacity-50",
        "-translate-x-1/2 top-1/2 -translate-y-1/2",
        Disabled ? "" : "cursor-grab active:cursor-grabbing",
        ThumbClass
    );

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        if (_jsModule != null && _jsInitialized)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("disposeSlider", _sliderId);
                await _jsModule.DisposeAsync();
            }
            catch { }
        }
        _dotNetRef?.Dispose();
    }
}
