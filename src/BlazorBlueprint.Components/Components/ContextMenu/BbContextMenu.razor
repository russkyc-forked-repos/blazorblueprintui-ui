@namespace BlazorBlueprint.Components
@using Microsoft.JSInterop
@implements IAsyncDisposable

<CascadingValue Value="this" IsFixed="false">
    @ChildContent
</CascadingValue>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public bool? Open { get; set; }

    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    internal bool IsOpen { get; private set; }
    internal double X { get; private set; }
    internal double Y { get; private set; }
    internal bool NeedsFocus { get; set; }

    private DotNetObjectReference<BbContextMenu>? _dotNetRef;
    private bool _disposed;

    protected override void OnInitialized()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
    }

    internal async Task OpenAt(double x, double y)
    {
        X = x;
        Y = y;
        IsOpen = true;
        NeedsFocus = true;

        if (Open.HasValue)
        {
            await OpenChanged.InvokeAsync(true);
        }

        StateHasChanged();
    }

    internal async Task Close()
    {
        IsOpen = false;

        if (Open.HasValue)
        {
            await OpenChanged.InvokeAsync(false);
        }

        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleClickOutside()
    {
        if (_disposed) return;
        await Close();
    }

    public ValueTask DisposeAsync()
    {
        _disposed = true;
        _dotNetRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}
