@namespace BlazorBlueprint.Components
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Context?.IsOpen == true)
{
    <div @ref="_overlayRef"
         class="fixed inset-0 z-40"
         @onclick="HandleOverlayClick"
         @onclick:stopPropagation="true"
         @oncontextmenu="HandleOverlayClose"
         @oncontextmenu:preventDefault="true"></div>
    <div @ref="_contentRef"
         class="@CssClass"
         style="position: fixed; left: @(Context.X)px; top: @(Context.Y)px; z-index: 50;"
         @onclick:stopPropagation="true"
         @oncontextmenu:preventDefault="true"
         tabindex="-1"
         role="menu">
        <div class="p-1">
            @ChildContent
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public BbContextMenu? Context { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public bool Loop { get; set; } = true;

    private ElementReference _overlayRef;
    private ElementReference _contentRef;
    private IJSObjectReference? _portalModule;
    private IJSObjectReference? _menuKeyboardModule;
    private DotNetObjectReference<BbContextMenuContent>? _dotNetRef;
    private readonly string _instanceId = Guid.NewGuid().ToString("N")[..8];
    private bool _disposed;
    private bool _wasOpen;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Context?.IsOpen == true && !_wasOpen)
        {
            _wasOpen = true;
            Context.NeedsFocus = false;
            try
            {
                _menuKeyboardModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/BlazorBlueprint.Primitives/js/primitives/menu-keyboard.js");
                _dotNetRef ??= DotNetObjectReference.Create(this);

                await _menuKeyboardModule.InvokeVoidAsync("initialize", _contentRef, _dotNetRef, _instanceId,
                    new { mode = "vertical", loop = Loop, initialFocus = "first" });
            }
            catch (JSDisconnectedException)
            {
                // Expected during circuit disconnect in Blazor Server
            }
            catch (InvalidOperationException)
            {
                // JS interop not available during prerendering
            }
        }
        else if (Context?.IsOpen != true && _wasOpen)
        {
            _wasOpen = false;
            await CleanupKeyboardAsync();
        }
    }

    [JSInvokable]
    public async Task JsOnEscapeKey()
    {
        if (_disposed) { return; }

        if (Context != null)
        {
            await Context.Close();
        }
    }

    private async Task CleanupKeyboardAsync()
    {
        if (_menuKeyboardModule != null)
        {
            try
            {
                await _menuKeyboardModule.InvokeVoidAsync("dispose", _instanceId);
            }
            catch
            {
                // Cleanup may already be disposed
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        GC.SuppressFinalize(this);
        _disposed = true;

        await CleanupKeyboardAsync();

        try
        {
            if (_portalModule != null)
            {
                await _portalModule.DisposeAsync();
            }

            if (_menuKeyboardModule != null)
            {
                await _menuKeyboardModule.DisposeAsync();
            }
        }
        catch (JSDisconnectedException)
        {
            // Expected during circuit disconnect
        }

        _dotNetRef?.Dispose();
    }

    private async Task HandleOverlayClick()
    {
        if (Context != null)
        {
            await Context.Close();
        }
    }

    private async Task HandleOverlayClose(MouseEventArgs e)
    {
        if (Context != null)
        {
            try
            {
                _portalModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/BlazorBlueprint.Primitives/js/primitives/portal.js");
                await _portalModule.InvokeVoidAsync("redispatchContextMenu", _overlayRef, _contentRef, e.ClientX, e.ClientY);
            }
            catch
            {
                // Ignore errors during prerendering
            }

            await Context.Close();
        }
    }

    private string CssClass => ClassNames.cn(
        "min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md outline-none",
        "animate-in fade-in-0 zoom-in-95",
        Class
    );
}
