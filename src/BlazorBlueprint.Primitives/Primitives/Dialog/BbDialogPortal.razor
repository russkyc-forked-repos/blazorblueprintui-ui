@namespace BlazorBlueprint.Primitives.Dialog
@inject IPortalService PortalService
@implements IDisposable

@*
    DialogPortal renders its content at the document body level using PortalService.
    This ensures proper z-index stacking for overlays.
    When Container is set, renders inline instead (for contained scenarios).
*@

@if (!string.IsNullOrEmpty(Container))
{
    @if (Context.IsOpen || ForceMount)
    {
        <CascadingValue Value="Context" IsFixed="false">
            @ChildContent
        </CascadingValue>
    }
}

@code {
    [CascadingParameter]
    private DialogContext Context { get; set; } = null!;

    /// <summary>
    /// The content to render in the portal (typically DialogOverlay and DialogContent).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The container element to render the portal into.
    /// When null (default), renders into document body via PortalService.
    /// When set, renders inline within the current component tree, allowing
    /// the content to be contained by a parent element with CSS containment
    /// (e.g. transform: translateZ(0)).
    /// </summary>
    [Parameter]
    public string? Container { get; set; }

    /// <summary>
    /// Whether to force rendering in a portal.
    /// When false, portal is only used when dialog is open.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool ForceMount { get; set; } = false;

    private string _portalId = string.Empty;
    private bool _isRegistered = false;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException(
                "DialogPortal must be used within a Dialog component. " +
                "Ensure DialogPortal is a child of a Dialog component.");
        }

        _portalId = $"{Context.Id}-portal";

        // Subscribe to context changes to update portal content
        Context.OnStateChanged += HandleStateChanged;

        // When Container is set, content renders inline — skip portal registration
        if (string.IsNullOrEmpty(Container))
        {
            // Register initial portal if dialog is open or force mount
            if (Context.IsOpen || ForceMount)
            {
                RegisterPortal();
            }
        }
    }

    protected override void OnParametersSet()
    {
        // When Container is set, content renders inline — skip portal registration
        if (!string.IsNullOrEmpty(Container))
        {
            UnregisterPortal();
            return;
        }

        if (Context.IsOpen || ForceMount)
        {
            if (!_isRegistered)
            {
                RegisterPortal();
            }
            else
            {
                PortalService.RefreshPortal(_portalId);
            }
        }
        else
        {
            UnregisterPortal();
        }
    }

    private void HandleStateChanged()
    {
        StateHasChanged();
    }

    private void RegisterPortal()
    {
        if (!_isRegistered && ChildContent != null)
        {
            PortalService.RegisterPortal(_portalId, GetPortalContent(), PortalCategory.Container);
            _isRegistered = true;
        }
    }

    private RenderFragment GetPortalContent() => builder =>
    {
        builder.OpenComponent<CascadingValue<DialogContext>>(0);
        builder.AddAttribute(1, "Value", Context);
        builder.AddAttribute(2, "IsFixed", false);
        builder.AddAttribute(3, "ChildContent", ChildContent);
        builder.CloseComponent();
    };

    private void UnregisterPortal()
    {
        if (_isRegistered)
        {
            PortalService.UnregisterPortal(_portalId);
            _isRegistered = false;
        }
    }

    public void Dispose()
    {
        UnregisterPortal();

        if (Context != null)
        {
            Context.OnStateChanged -= HandleStateChanged;
        }
    }
}
