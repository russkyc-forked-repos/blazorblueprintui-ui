@namespace BlazorBlueprint.Primitives.Sheet
@using BlazorBlueprint.Primitives.Utilities

@* Sheet trigger button - opens the sheet when clicked *@
@if (AsChild)
{
    @* When AsChild is true, pass trigger context to child for it to handle *@
    <CascadingValue Value="TriggerContext" Name="TriggerContext">
        @ChildContent
    </CascadingValue>
}
else
{
    <button type="button"
            id="@Context.TriggerId"
            @onclick="HandleClick"
            @attributes="AdditionalAttributes"
            aria-haspopup="dialog"
            aria-expanded="@Context.IsOpen.ToString().ToLower()"
            aria-controls="@Context.ContentId">
        @ChildContent
    </button>
}

@code {
    [CascadingParameter]
    private SheetContext Context { get; set; } = null!;

    /// <summary>
    /// The content to display inside the trigger button.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// When true, the trigger does not render its own button element.
    /// Instead, it passes trigger behavior via TriggerContext to child components.
    /// The child component must consume TriggerContext and apply click/aria behavior.
    /// </summary>
    [Parameter]
    public bool AsChild { get; set; } = false;

    /// <summary>
    /// Additional attributes to apply to the trigger button element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Custom click handler. If provided, this is called instead of the default toggle behavior.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    /// <summary>
    /// Whether to use custom click handling. When true, only OnClick is invoked.
    /// Default is false (sheet opens on click).
    /// </summary>
    [Parameter]
    public bool CustomClickHandling { get; set; } = false;

    /// <summary>
    /// Context passed to child components when AsChild is true.
    /// </summary>
    private TriggerContext TriggerContext => new()
    {
        TriggerId = Context.TriggerId,
        IsOpen = Context.IsOpen,
        Toggle = () => Context.Toggle(),
        Open = () => Context.Open(),
        Close = () => Context.Close(),
        AriaHasPopup = "dialog",
        AriaControls = Context.ContentId
    };

    private async Task HandleClick(MouseEventArgs args)
    {
        if (CustomClickHandling && OnClick.HasDelegate)
        {
            // Custom handling only
            await OnClick.InvokeAsync(args);
        }
        else
        {
            // Default: toggle sheet
            Context.Toggle();

            // Also invoke custom handler if provided
            if (OnClick.HasDelegate)
            {
                await OnClick.InvokeAsync(args);
            }
        }
    }

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException(
                "SheetTrigger must be used within a Sheet component. " +
                "Ensure SheetTrigger is a child of a Sheet component.");
        }
    }
}
