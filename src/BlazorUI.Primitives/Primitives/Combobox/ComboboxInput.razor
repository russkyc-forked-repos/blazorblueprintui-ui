@namespace BlazorUI.Primitives.Combobox
@inject IJSRuntime JS
@implements IAsyncDisposable

@* ComboboxInput primitive - headless input element for search/filtering *@
<input @ref="_inputElement"
       id="@Context.InputId"
       type="text"
       role="combobox"
       aria-expanded="@(_hasVisibleItems ? "true" : "false")"
       aria-controls="@Context.ContentId"
       aria-activedescendant="@(_focusedItemId)"
       value="@Context.SearchQuery"
       @oninput="HandleInput"
       disabled="@Context.Disabled"
       @attributes="AdditionalAttributes" />

@code {
    [CascadingParameter]
    public ComboboxContext Context { get; set; } = null!;

    private ElementReference _inputElement;
    private string? _focusedItemId;
    private bool _hasVisibleItems;
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<ComboboxInput>? _dotNetRef;
    private bool _previousAutoFocus;

    /// <summary>
    /// Additional attributes to apply to the input element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Gets or sets whether the input should auto-focus when rendered.
    /// </summary>
    [Parameter]
    public bool AutoFocus { get; set; }

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(ComboboxInput)} must be used within a {nameof(Combobox)} component.");
        }

        // Subscribe to context state changes to update ARIA attributes
        Context.OnStateChanged += HandleContextStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Store input element reference in context
            Context.State.InputElement = _inputElement;

            // Set up JavaScript interop for keyboard navigation
            try
            {
                _jsModule = await JS.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/BlazorUI.Primitives/js/primitives/combobox.js");

                _dotNetRef = DotNetObjectReference.Create(this);

                await _jsModule.InvokeVoidAsync("setupComboboxInput",
                    _inputElement, _dotNetRef, Context.InputId, Context.ContentId);
            }
            catch (Exception ex)
            {
                // JS module not critical, log and continue
                Console.WriteLine($"Failed to setup combobox keyboard handler: {ex.Message}");
            }
        }

        // Auto-focus when AutoFocus changes from false to true (combobox opens)
        if (AutoFocus && !_previousAutoFocus && _jsModule != null)
        {
            try
            {
                // Use custom focus function with preventScroll to avoid page jumping
                // Pass element ID instead of ElementReference for better setTimeout compatibility
                await _jsModule.InvokeVoidAsync("focusElementByIdWithPreventScroll", Context.InputId);
            }
            catch
            {
                // Ignore focus errors
            }
        }

        // Update previous state for next render
        _previousAutoFocus = AutoFocus;
    }

    private void HandleInput(ChangeEventArgs e)
    {
        var newQuery = e.Value?.ToString() ?? string.Empty;
        Context.UpdateSearchQuery(newQuery);
        StateHasChanged(); // Force immediate re-render
    }

    /// <summary>
    /// Handles Escape key from JavaScript to clear search.
    /// </summary>
    [JSInvokable]
    public void HandleEscape()
    {
        Context.ClearSearch();
    }

    private void HandleContextStateChanged()
    {
        // Update ARIA attributes based on context state
        var filteredItems = Context.GetFilteredItems();
        _hasVisibleItems = filteredItems.Any();

        if (Context.FocusedIndex >= 0 && Context.FocusedIndex < filteredItems.Count)
        {
            _focusedItemId = Context.GetItemId(Context.FocusedIndex);
        }
        else
        {
            _focusedItemId = null;
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }

        // Cleanup JavaScript interop
        if (_jsModule != null && Context != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("removeComboboxInput", Context.InputId);
                await _jsModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }

        _dotNetRef?.Dispose();
    }
}
