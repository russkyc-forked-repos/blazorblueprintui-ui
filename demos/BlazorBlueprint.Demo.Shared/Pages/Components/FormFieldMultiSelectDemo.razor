@page "/components/form-field-multi-select"
@using System.ComponentModel.DataAnnotations

<PageTitle>FormFieldMultiSelect Component - Blazor Blueprint</PageTitle>

<div class="space-y-8 max-w-4xl">
    <div>
        <div class="space-y-3">
            <div class="flex items-center gap-3">
                <h1 class="text-4xl font-bold tracking-tight">FormFieldMultiSelect</h1>
                <span class="inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary ring-1 ring-inset ring-primary/20">v3</span>
            </div>
            <p class="text-xl text-muted-foreground">
                A form field wrapper for MultiSelect with built-in label, helper text, and error messages.
            </p>
        </div>
    </div>

    <!-- Which form component? -->
    <div class="rounded-lg border border-dashed bg-muted/30 p-6 space-y-3">
        <h2 class="text-lg font-semibold">Which form component?</h2>
        <div class="space-y-2 text-sm text-muted-foreground">
            <p><strong>Text input</strong> (string, int, date, etc.)? &rarr; <a href="/components/form-field-input" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldInput&lt;T&gt;</a></p>
            <p><strong>Checkbox</strong>? &rarr; <a href="/components/form-field-checkbox" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldCheckbox</a></p>
            <p><strong>Switch</strong>? &rarr; <a href="/components/form-field-switch" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldSwitch</a></p>
            <p><strong>Radio group</strong>? &rarr; <a href="/components/form-field-radio-group" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldRadioGroup</a></p>
            <p><strong>Select dropdown</strong>? &rarr; <a href="/components/form-field-select" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldSelect</a></p>
            <p><strong>Searchable select</strong>? &rarr; <a href="/components/form-field-combobox" class="text-primary underline underline-offset-4 hover:text-primary/80">FormFieldCombobox</a></p>
            <p><strong>Multi-select</strong>? &rarr; <strong>FormFieldMultiSelect</strong> (this page)</p>
        </div>
    </div>

    <!-- Basic Example -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Basic Usage</h2>
            <p class="text-sm text-muted-foreground">
                A multi-select with label, helper text, and search. Selected items appear as tags.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="string"
                                  Options="_languages"
                                  @bind-Values="_selectedLanguages"
                                  Label="Programming languages"
                                  Placeholder="Select languages..."
                                  SearchPlaceholder="Search languages..."
                                  HelperText="Select all languages you are proficient in."
                                  MatchTriggerWidth="true"
                                  InputClass="w-full" />
        </div>
        <div class="rounded-lg border p-4 bg-muted/50 space-y-1">
            <p class="text-sm"><span class="font-medium">Selected values:</span> <span class="font-mono">@(_selectedLanguages?.Any() == true ? string.Join(", ", _selectedLanguages) : "(none)")</span></p>
            <p class="text-sm"><span class="font-medium">Selected text:</span> @(_selectedLanguages?.Any() == true ? string.Join(", ", _languages.GetTexts(_selectedLanguages)) : "(none)")</p>
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/basic.txt" />
    </div>

    <!-- Compositional Mode -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Compositional Mode</h2>
            <p class="text-sm text-muted-foreground">
                For full control over item rendering, omit <code class="text-xs bg-muted px-1 py-0.5 rounded">Options</code>
                and use <code class="text-xs bg-muted px-1 py-0.5 rounded">MultiSelectItem</code> children instead.
                Search, Select All, keyboard navigation, and checkbox indicators work identically.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="string"
                                  @bind-Values="_compositionalValues"
                                  Label="Permissions"
                                  Placeholder="Select permissions..."
                                  SearchPlaceholder="Search..."
                                  ShowSelectAll="true"
                                  SelectAllLabel="Select All"
                                  HelperText="Assign access permissions."
                                  MatchTriggerWidth="true"
                                  InputClass="w-full">
                <BbMultiSelectItem Value="@("read")" Text="Read">
                    <div class="flex items-center gap-2">
                        <span class="inline-block h-2 w-2 rounded-full bg-green-500"></span>
                        Read
                    </div>
                </BbMultiSelectItem>
                <BbMultiSelectItem Value="@("write")" Text="Write">
                    <div class="flex items-center gap-2">
                        <span class="inline-block h-2 w-2 rounded-full bg-yellow-500"></span>
                        Write
                    </div>
                </BbMultiSelectItem>
                <BbMultiSelectItem Value="@("delete")" Text="Delete">
                    <div class="flex items-center gap-2">
                        <span class="inline-block h-2 w-2 rounded-full bg-red-500"></span>
                        Delete
                    </div>
                </BbMultiSelectItem>
                <BbMultiSelectItem Value="@("admin")" Text="Admin">
                    <div class="flex items-center gap-2">
                        <span class="inline-block h-2 w-2 rounded-full bg-purple-500"></span>
                        Admin
                    </div>
                </BbMultiSelectItem>
            </BbFormFieldMultiSelect>
        </div>
        <div class="rounded-lg border p-4 bg-muted/50 space-y-1">
            <p class="text-sm"><span class="font-medium">Selected values:</span> <span class="font-mono">@(_compositionalValues?.Any() == true ? string.Join(", ", _compositionalValues) : "(none)")</span></p>
            <p class="text-sm"><span class="font-medium">Selected text:</span> @(_compositionalValues?.Any() == true ? string.Join(", ", _compositionalValues.Select(GetCompositionalLabel)) : "(none)")</p>
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/compositional.txt" />
    </div>

    <!-- Non-String Value Types -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Non-String Value Types</h2>
            <p class="text-sm text-muted-foreground">
                Use <code class="text-xs bg-muted px-1 py-0.5 rounded">TValue</code> to bind to non-string types such as
                <code class="text-xs bg-muted px-1 py-0.5 rounded">IEnumerable&lt;int&gt;?</code>. The component handles
                conversion automatically.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="int"
                                  Options="_permissions"
                                  @bind-Values="_selectedPermissions"
                                  Label="Permissions"
                                  Placeholder="Select permissions..."
                                  SearchPlaceholder="Search permissions..."
                                  HelperText="Assign permissions to this role."
                                  MatchTriggerWidth="true"
                                  InputClass="w-full" />
        </div>
        <div class="rounded-lg border p-4 bg-muted/50 space-y-1">
            <p class="text-sm"><span class="font-medium">Selected values:</span> <span class="font-mono">@(_selectedPermissions?.Any() == true ? string.Join(", ", _selectedPermissions) : "(none)")</span></p>
            <p class="text-sm"><span class="font-medium">Selected text:</span> @(_selectedPermissions?.Any() == true ? string.Join(", ", _permissions.GetTexts(_selectedPermissions)) : "(none)")</p>
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/non-string.txt" />
    </div>

    <!-- Guid Values -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Guid Values</h2>
            <p class="text-sm text-muted-foreground">
                Bind to <code class="text-xs bg-muted px-1 py-0.5 rounded">IEnumerable&lt;Guid&gt;?</code> values when your items use
                unique identifiers. Set <code class="text-xs bg-muted px-1 py-0.5 rounded">TValue="Guid"</code> and
                the component handles serialization and comparison.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="Guid"
                                  Options="_projects"
                                  @bind-Values="_selectedProjects"
                                  Label="Projects"
                                  Placeholder="Select projects..."
                                  SearchPlaceholder="Search projects..."
                                  HelperText="Choose projects to include."
                                  MatchTriggerWidth="true"
                                  InputClass="w-full" />
        </div>
        <div class="rounded-lg border p-4 bg-muted/50 space-y-1">
            <p class="text-sm"><span class="font-medium">Selected values:</span> <span class="font-mono">@(_selectedProjects?.Any() == true ? string.Join(", ", _selectedProjects) : "(none)")</span></p>
            <p class="text-sm"><span class="font-medium">Selected text:</span> @(_selectedProjects?.Any() == true ? string.Join(", ", _projects.GetTexts(_selectedProjects)) : "(none)")</p>
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/guid.txt" />
    </div>

    <!-- Without Select All -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Without Select All</h2>
            <p class="text-sm text-muted-foreground">
                Use <code class="text-xs bg-muted px-1 py-0.5 rounded">ShowSelectAll="false"</code> to
                hide the Select All option.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="string"
                                  Options="_technologies"
                                  @bind-Values="_selectedTechnologies"
                                  Label="Tech stack"
                                  Placeholder="Select technologies..."
                                  SearchPlaceholder="Search..."
                                  ShowSelectAll="false"
                                  MaxDisplayTags="2"
                                  MatchTriggerWidth="true"
                                  InputClass="w-full" />
        </div>
        <div class="rounded-lg border p-4 bg-muted/50 space-y-1">
            <p class="text-sm"><span class="font-medium">Selected values:</span> <span class="font-mono">@(_selectedTechnologies?.Any() == true ? string.Join(", ", _selectedTechnologies) : "(none)")</span></p>
            <p class="text-sm"><span class="font-medium">Selected text:</span> @(_selectedTechnologies?.Any() == true ? string.Join(", ", _technologies.GetTexts(_selectedTechnologies)) : "(none)")</p>
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/without-select-all.txt" />
    </div>

    <!-- Disabled -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Disabled</h2>
            <p class="text-sm text-muted-foreground">
                A disabled multi-select form field with pre-selected values.
            </p>
        </div>
        <div class="max-w-md">
            <BbFormFieldMultiSelect TValue="string"
                                  Options="_languages"
                                  Values="@(new[] { "csharp", "typescript" })"
                                  Label="Required skills"
                                  HelperText="These skills are required for this role."
                                  MatchTriggerWidth="true"
                                  InputClass="w-full"
                                  Disabled="true" />
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/disabled.txt" />
    </div>

    <!-- EditForm Integration -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">EditForm Integration</h2>
            <p class="text-sm text-muted-foreground">
                Validation errors display automatically inside an EditForm.
                Try submitting without selecting any skills.
            </p>
        </div>
        <div class="max-w-md">
            <EditForm Model="_formModel" OnValidSubmit="HandleFormSubmit">
                <DataAnnotationsValidator />
                <div class="space-y-4">
                    <BbFormFieldMultiSelect TValue="string"
                                          Options="_languages"
                                          @bind-Values="_formModel.Skills"
                                          Label="Skills"
                                          Placeholder="Select your skills..."
                                          SearchPlaceholder="Search skills..."
                                          MatchTriggerWidth="true"
                                          InputClass="w-full" />
                    <BbButton Type="ButtonType.Submit">Submit</BbButton>
                </div>
            </EditForm>
            @if (_formSubmitted)
            {
                <div class="mt-4 rounded-lg border border-green-200 bg-green-50 dark:bg-green-950 dark:border-green-800 p-4 space-y-1">
                    <p class="text-sm font-medium text-green-800 dark:text-green-200">
                        Submitted values: <span class="font-mono">@(_formModel.Skills != null ? string.Join(", ", _formModel.Skills) : "(none)")</span>
                    </p>
                    <p class="text-sm font-medium text-green-800 dark:text-green-200">
                        Submitted text: @(_formModel.Skills != null ? string.Join(", ", _languages.GetTexts(_formModel.Skills)) : "(none)")
                    </p>
                </div>
            }
        </div>
        <CodeBlock Source="Components/FormFieldMultiSelect/edit-form.txt" />
    </div>

    <AccessibilityList>
        <AriaAttributes>
            <AccessibilityItem>Automatically associates label with input via generated ID</AccessibilityItem>
            <AccessibilityItem>Description linked via aria-describedby</AccessibilityItem>
            <AccessibilityItem>Validation errors displayed with aria-invalid</AccessibilityItem>
        </AriaAttributes>
    </AccessibilityList>

    <!-- API Reference -->
    <section class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">API Reference</h2>
            <p class="text-muted-foreground">Component properties and parameters.</p>
        </div>
        <div class="space-y-4">
            <ApiReference ComponentName="FormFieldMultiSelect&lt;TValue&gt;">
                <ApiParameter Name="Label" Type="string?" Default="null">
                    The label text displayed above the multi-select.
                </ApiParameter>
                <ApiParameter Name="HelperText" Type="string?" Default="null">
                    Helper text displayed below the multi-select. Hidden during error state.
                </ApiParameter>
                <ApiParameter Name="ErrorText" Type="string?" Default="null">
                    Manual error text override. When the field is invalid and this is set, replaces auto-generated messages.
                </ApiParameter>
                <ApiParameter Name="Orientation" Type="FieldOrientation" Default="Vertical">
                    Layout orientation of the field.
                </ApiParameter>
                <ApiParameter Name="Options" Type="IEnumerable&lt;SelectOption&lt;TValue&gt;&gt;?" Default="null">
                    Collection of options to display. When provided, uses Options mode. When null, uses Compositional mode with ChildContent.
                </ApiParameter>
                <ApiParameter Name="Values" Type="IEnumerable&lt;TValue&gt;?" Default="null">
                    The currently selected values. Use @@bind-Values for two-way binding.
                </ApiParameter>
                <ApiParameter Name="ValuesChanged" Type="EventCallback&lt;IEnumerable&lt;TValue&gt;?&gt;">
                    Callback invoked when the selected values change.
                </ApiParameter>
                <ApiParameter Name="Placeholder" Type="string" Default="&quot;Select items...&quot;">
                    Placeholder text shown when no items are selected.
                </ApiParameter>
                <ApiParameter Name="SearchPlaceholder" Type="string" Default="&quot;Search...&quot;">
                    Placeholder text shown in the search input.
                </ApiParameter>
                <ApiParameter Name="EmptyMessage" Type="string" Default="&quot;No results found.&quot;">
                    Message displayed when no items match the search.
                </ApiParameter>
                <ApiParameter Name="ShowSelectAll" Type="bool" Default="true">
                    Whether to show the Select All option.
                </ApiParameter>
                <ApiParameter Name="SelectAllLabel" Type="string" Default="&quot;Select All&quot;">
                    Label for the Select All option.
                </ApiParameter>
                <ApiParameter Name="ClearLabel" Type="string" Default="&quot;Clear&quot;">
                    Label for the Clear button.
                </ApiParameter>
                <ApiParameter Name="CloseLabel" Type="string" Default="&quot;Close&quot;">
                    Label for the Close button.
                </ApiParameter>
                <ApiParameter Name="MaxDisplayTags" Type="int" Default="3">
                    Maximum number of tags to display before showing "+N more".
                </ApiParameter>
                <ApiParameter Name="Disabled" Type="bool" Default="false">
                    Whether the multi-select is disabled.
                </ApiParameter>
                <ApiParameter Name="MatchTriggerWidth" Type="bool" Default="false">
                    Whether to match the dropdown width to the trigger element width.
                </ApiParameter>
                <ApiParameter Name="PopoverWidth" Type="string" Default="&quot;w-[300px]&quot;">
                    CSS class for the width of the popover content.
                </ApiParameter>
                <ApiParameter Name="AutoClose" Type="bool" Default="true">
                    Whether clicking outside the dropdown should close it.
                </ApiParameter>
                <ApiParameter Name="InputClass" Type="string?" Default="null">
                    Additional CSS classes applied to the inner MultiSelect element.
                </ApiParameter>
                <ApiParameter Name="Class" Type="string?" Default="null">
                    Additional CSS classes applied to the outer Field container.
                </ApiParameter>
                <ApiParameter Name="AriaLabel" Type="string?" Default="null">
                    ARIA label for the control.
                </ApiParameter>
                <ApiParameter Name="ChildContent" Type="RenderFragment?" Default="null">
                    Content for compositional mode. Use MultiSelectItem components as children.
                </ApiParameter>
            </ApiReference>
        </div>
    </section>
</div>

@code {
    private IEnumerable<string>? _selectedLanguages;
    private IEnumerable<string>? _compositionalValues;
    private IEnumerable<string>? _selectedTechnologies;
    private IEnumerable<int>? _selectedPermissions;
    private IEnumerable<Guid>? _selectedProjects;
    private bool _formSubmitted;
    private MultiSelectFormModel _formModel = new();

    private readonly SelectOption<string>[] _languages =
    [
        new("csharp", "C#"),
        new("typescript", "TypeScript"),
        new("javascript", "JavaScript"),
        new("python", "Python"),
        new("java", "Java"),
        new("go", "Go"),
        new("rust", "Rust"),
        new("php", "PHP")
    ];

    private readonly SelectOption<string>[] _technologies =
    [
        new("react", "React"),
        new("vue", "Vue.js"),
        new("angular", "Angular"),
        new("blazor", "Blazor"),
        new("nextjs", "Next.js"),
        new("dotnet", ".NET"),
        new("docker", "Docker")
    ];

    private readonly SelectOption<int>[] _permissions =
    [
        new(1, "Read"),
        new(2, "Write"),
        new(3, "Delete"),
        new(4, "Admin"),
        new(5, "Export")
    ];

    private readonly SelectOption<Guid>[] _projects =
    [
        new(Guid.Parse("a1b2c3d4-0001-0000-0000-000000000001"), "Alpha"),
        new(Guid.Parse("a1b2c3d4-0002-0000-0000-000000000002"), "Beta"),
        new(Guid.Parse("a1b2c3d4-0003-0000-0000-000000000003"), "Gamma"),
        new(Guid.Parse("a1b2c3d4-0004-0000-0000-000000000004"), "Delta")
    ];

    private readonly Dictionary<string, string> _compositionalLabels = new()
    {
        ["read"] = "Read",
        ["write"] = "Write",
        ["delete"] = "Delete",
        ["admin"] = "Admin"
    };

    private string GetCompositionalLabel(string value) =>
        _compositionalLabels.GetValueOrDefault(value) ?? value;

    private void HandleFormSubmit()
    {
        _formSubmitted = true;
    }

    private class MultiSelectFormModel
    {
        [Required(ErrorMessage = "Please select at least one skill.")]
        public IEnumerable<string>? Skills { get; set; }
    }
}
